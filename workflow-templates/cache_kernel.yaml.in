  cache_kernel:
    name: Cache %%KERNEL_FLAVOR%% (%%VERSION%%)
    runs-on: ubuntu-24.04
    outputs:
      KCKEY: %%KERNEL_FLAVOR%%-${{ steps.kernel-version.outputs.kernel_release }}
      json_b64: ${{ steps.kernel-version.outputs.json_b64 }}
    container:
      image: "ghcr.io/ublue-os/devcontainer:latest"
      options: "--privileged --volume /var/lib/containers:/var/lib/containers --security-opt seccomp=unconfined --security-opt label=disable --user 0:0"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Mark Directory as Safe
        run: git config --system --ad safe.directory "$GITHUB_WORKSPACE"
      
      - name: Get Kernel Version
        id: kernel-version
        run: just get-kernel-version

      - name: Cache Kernel RPMs
        id: cache-kernel
        uses: actions/cache@v4
        with:
          path: ${{ steps.kernel-version.outputs.KCPATH }}
          key: %%KERNEL_FLAVOR%%-${{ steps.kernel-version.outputs.kernel_release }} # job outputs KCKEY

      - name: Retrieve Signing Key
        if: steps.cache-kernel.outputs.cache-hit != 'true' && contains(fromJSON('["schedule", "workflow_dispatch", "merge_group"]'), github.event_name)
        shell: bash
        run: |
          mkdir -p certs
          echo "${{ secrets.KERNEL_PRIVKEY }}" > certs/private_key.priv
          echo "${{ secrets.AKMOD_PRIVKEY_20230518 }}" > certs/private_key_2.priv
          # DEBUG: get character count of key
          wc -c certs/private_key.priv
          wc -c certs/private_key_2.priv

      - name: Fetch Kernel
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: just fetch-kernel
      
      - name: Finalize Cache Files
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        shell: bash
        run: echo "$(date '+%Y%m%d.0')" > ${{ steps.kernel-version.outputs.KCPATH }}/kernel-cache-date

      - name: List Cached Kernel RPMs
        shell: bash
        run: find ${{ steps.kernel-version.outputs.KCPATH }}
